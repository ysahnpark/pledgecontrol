<?php namespace Altenia\Ecofy\Service;
/**
 * Mongo Service from schema: docuflow version 0.1
 * Code generated by TransformTask
 *
 */


class PredefinedAcl
{
    // @TODO take this away from here
    public static $serviceAcl = array();

    public static function get($role) {
        if (self::$serviceAcl == null) {
            self::$serviceAcl = array();
            $adminAc = new \AccessControl();
            $adminAc->permissions = 31;
            $adminAc->setPolicyFromJson('
                    {
                        "svc:user": {"@permissions": 31},
                        "svc:organization": {"@permissions": 31},
                        "svc:role": {"@permissions": 31},
                        "svc:document_type": {"@permissions": 31},
                        "svc:workflow": {"@permissions": 31}
                    }');
            self::$serviceAcl['admin'] = $adminAc;

            $staffAc = new \AccessControl();
            $staffAc->permissions = 31;
            $staffAc->setPolicyFromJson('
                    {
                        "svc:user": {"@permissions": 15},
                        "svc:organization": {"@permissions": 31},
                        "svc:document_type": {"@permissions": 7}
                    }');
            self::$serviceAcl['staff'] = $staffAc;


            $defaultAc = new \AccessControl();
            $defaultAc->permissions = 1;
            $defaultAc->setPolicyFromJson('
                    {
                    }');
            self::$serviceAcl['default'] = $defaultAc;
        }
        if (array_key_exists($role, self::$serviceAcl)) {
            return self::$serviceAcl[$role];
        }
        return self::$serviceAcl['default'];
    }
}

/**
 * Service class that provides business logic for access_control
 */
class AccessControlServiceMongo extends BaseServiceMongo {

    /**
     * Constructor
     */
    public function __construct($id = 'access_control')
    {
    	parent::__construct($id, 'access_control');
    }

	/**
	 * Returns list of the records.
	 *
	 * @param array $criteria     Parameters used for querying
	 * @param int   $sortParams   Parameters used for sorting
	 * @param int   $offset       The starting record
	 * @param int   $limit        Maximum number of records to retrieve
	 * @return Response
	 */
	public function listAccessControls($criteria, $sortParams = array(), $offset = 0, $limit=100)
	{
		$query = $this->buildQuery($criteria);
        $cursor = $this->db_collection->find( $query )
        	->skip($offset)->limit($limit);

        $records = array();
        while ($cursor->hasNext())
        {
            $doc = $cursor->getNext();
            $records[] = $this->toModel($doc);
        }
        $result = new \Illuminate\Support\Collection($records);
        
        return $result;
	}

	/**
	 * Returns paginated list of the records.
	 *
	 * @param array $queryParams  Parameters used for querying
	 * @param int   $page_size    The max number of entries shown per page
	 * @return Response
	 */
	public function paginateAccessControls($queryParams, $page_size = 20)
	{
	    // @TODO: pending
		$query = \AccessControl::query();
		$query = $this->parseQueryParams($query, $queryParams);
        $records = $query->paginate($page_size);
		return $records;
	}

    /**
	 * Returns the count of records satisfying the critieria.
	 *
	 * @param array $criteria  Parameters used for querying
	 * @return int number of records that satisfied the criteria
	 */
	public function countAccessControls($criteria)
	{
		$count = $this->db_collection->find( $criteria )->count();
		return $count;
	}

	/**
	 * Creates a new records.
	 * Mostly wrapper around insert with pre and post processing.
	 *
	 * @param array $data  Parameters used for creating a new record
	 * @return mixed  null if successful, validation object validation fails
	 */
	public function createAccessControl($data)
	{

		$validator = \AccessControl::validator($data);
        if ($validator->passes()) {
            $record = new \AccessControl();
            $record->fill($data);

            /*
             * @todo: assign default values as needed
             */
            $now = new \DateTime;
            $now_str = $now->format('Y-m-d H:i:s');
            $record->uuid = uniqid();
            $record->created_dt = $now_str;
            $record->updated_dt = $now_str;

            $arrModel = $record->toArray();
            $arrModel['_id'] = new \MongoId();
            $record->sid = (string)$arrModel['_id'];

            $this->db_collection->insert( $arrModel );

            return $record;
        } else {
            throw new ValidationException($validator);
        }
	}

	/**
	 * Retrieves a single record.
	 *
	 * @param  int $criteria  The primary key for the search
	 * @return AccessControl
	 */
	public function findAccessControl($criteria)
	{
        $doc = $this->db_collection->findOne( $criteria );

        $record = null;
        if (!empty($doc))
        {
            $record = $this->toModel($doc);
        }

		return $record;
	}

	/**
	 * Retrieves a single record.
	 *
	 * @param  int $pk  The primary key for the search
	 * @return AccessControl
	 */
	public function findAccessControlByPK($pk)
	{
		$criteria = array( '_id' => new \MongoId($pk) );
        return $this->findAccessControl($criteria);
	}

	/**
	 * Update the specified resource in storage.
	 *
	 * @param  int   $pk    The primary key of the record to update
	 * @param  array $data  The data of the update
	 * @return mixed null if successful, validation if validation error
	 */
	public function updateAccessControl($pk, $data)
	{
		$validator = \AccessControl::validator($data);
        if ($validator->passes()) {
            $record = $this->findAccessControlByPK($pk);
            $record->fill($data);

            $now = new \DateTime;
            $now_str = $now->format('Y-m-d H:i:s');
            $record->updated_dt = $now_str;

            $arrModel = $record->toArray();
            $criteria = array( '_id' => new \MongoId($pk) );
            $this->db_collection->update( $criteria, $arrModel );

            return $record;
        } else {
            throw new ValidationException($validator);
        }
	}

	/**
	 * Remove the specified resource from storage.
	 *
	 * @param  int  $pk
	 * @return Object the object that was deleted, null if not found
	 */
	public function destroyAccessControl($pk)
	{
		$record = $this->findAccessControlByPK($pk);
		if (!empty($record)) {
		    $criteria = array( '_id' => new \MongoId($pk) );
		    $this->db_collection->remove( $criteria );
		    return $record;
		}
		return null;
	}

	/**
	 * Returns the Laravel model object
	 */
    private function toModel($doc)
    {
        $model = new \AccessControl();
        $model->sid = (string)$doc['_id'];
        $model->fill($doc);
        return $model;
    }


    //////////

	/**
	 * Retrieves a access control of a user.
	 *
	 * @param  User $user  The primary key for the search
	 * @return AccessControl
	 */
	public function findAccessControlByUser($user)
	{
		$retval = null;
		if (!empty($user)) {
			if (!empty($user->role_sid)) {
				//$criteria = array( '_id' => new \MongoId($user->role_sid) );
				$criteria = array( 'role_sid' => $user->role_sid, 'service' => 'root' );
		        $retval = $this->findAccessControl($criteria);
		    }
		    if (empty($retval)) {
		    	$retval = PredefinedAcl::get($user->type);
		    }
		}
    	if (empty($retval)) {
    		$retval = PredefinedAcl::get('default');
    	}
		
	    return $retval;
	}
}
